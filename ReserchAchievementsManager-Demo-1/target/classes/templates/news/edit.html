<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>科研成果管理系统</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
	<link rel="stylesheet" type="text/css" href="/css/bootstrap-table.css">
	<link rel="stylesheet" type="text/css" href="/layui/css/layui.css">
	<link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
	<script type="text/javascript" src="/js/wangEditor.js"></script>
	<script type="text/javascript" src="/js/jquery-3.3.1.min.js"></script>
	<script type="text/javascript" src="/js/bootstrap.min.js"></script>
	<style>
		#content{
			margin-top:30px;
			margin-bottom:60px;
		}
		body{
			postion:relative;
			/* padding-bottom:200px; */
		}
		/* .footer{
			position:absolute;
			bottom:0px;
		} */
		p.title{ font-size:18px; font-family:"微软雅黑",sans-serif;
		}
		span.note{ background: rgba(242,13,13,.06);    border-radius: 6px;
    		font-weight: 700;    color: #A20D0D;font-size:16px;}
	</style>
</head>
<body>
	<div th:replace="header::html"></div>
	<div id="content" class="container">
		<div class="row" >
			<div class="col-md-8 col-md-offset-2">
				<form class="form-horizontal" action="">
					  <div class="form-group">
					    <label for="title" style="text-align:left"class="col-md-2 control-label">新闻标题</label>
					    <div class="col-md-6">
					      <input type="text" class="form-control" id="title" placeholder="请输入新闻标题..">
					    </div>
					  </div>
					  <div id="edit">
						<p>请填写新闻内容...</p>
					  </div>
					  <div class="form-group" style="margin-top:12px">
					    <div class="col-sm-12" style="text-align:center">
					      <button id="save" class="btn btn-primary">保存新闻</button>
					      <button  id="cancel" class="btn btn-success" style="margin-left:22px">退出</button>
					    </div>
					  </div>
				</form>
				<span id="note" class="note"></span>
			</div>
		</div>
		
	</div>
	
	<div th:replace="footer::html"></div>
	<script type="text/javascript">
/* 	window.onbeforeunload=function(e){     
		var message = '未保存内容将丢失，确认离开本页面吗？';
	    e = e || window.event;

	    if (e) {
	        e.returnValue = message;
	    }

	    return message;
		}  */
	//关闭窗口
		function CloseWebPage(){
			if (navigator.userAgent.indexOf("MSIE") > 0) {
				if (navigator.userAgent.indexOf("MSIE 6.0") > 0) {
				window.opener = null;
				window.close();
				}else {
				window.open('', '_top');
				window.top.close();
				}
			}
			else if (navigator.userAgent.indexOf("Firefox")>0 || navigator.userAgent.indexOf("Chrome")> 0) {
			    window.location.href = 'about:blank ';
				window.location.href="about:blank";
				window.close();
			}
			else {
				window.opener=null; 
				var mywindow = window.open('','_self');
				mywindow.close();
			}
		}
	 //请求，创建一个新的新闻，返回id
	  var nId; //新闻id
	  var timer = null; 
	  var news = {
			  nId:0,
			  title:"",
			  content:""
	  };
	  var editor = null;
	  var content = null;
	  
	  var create = function(){
		if (token == null) {
			window.location.href = '/index';
		}
		if (role != 'ROLE_ADMIN_01') {
			window.location.href = '/index';
		}
	  	$.ajax({
	  		url:"/news/create",
	  		type:"GET",
	  		headers: {Authorization: 'Bearer ' + token },	
	  		success:function(data){
	  			item = JSON.parse(data); 
	  			nId = item.nId;
	  			news.nId = item.nId;
	  			init();
	  		}
	  	});
	  }
	  if(news.nId == 0){
	  	create();
	  }
	  function init(){
	  //创建富文本编辑
		var E = window.wangEditor
		    editor = new E('#edit')
		    // 上传图片到服务器
		    editor.customConfig.uploadImgServer = '/attachment/imgUpload' ;
		    editor.customConfig.uploadFileName = 'img';
		    editor.customConfig.uploadImgHeaders = {
		    	'Authorization': 'Bearer ' + token 
		    }
		    editor.customConfig.uploadImgParams = {
		    	'nId':nId	   
		    }
		    editor.create()
	 }
	  //保存新闻
	  var save = function(event){
		  // 读取 html
		    console.log(news.nId);
		    var content = editor.txt.html();
		    var title = $("#title").val();
		    news.title = title;
		    news.content = content;
		    if(news.nId != 0){
		        //提交请求，保存内容
		        $.ajax({
		        	url:'/news/save',
		        	type:'POST',
		        	contentType : 'application/json',  
		        	headers: {Authorization: 'Bearer ' + token },	
		        	data:JSON.stringify({
		        			nId:nId,
		        			title:title,
		        			content:content
		             	}),
		             success:function(data){
		            	 result = JSON.parse(data);
		            	 state = result.state;
		            	 msg = result.msg
		            	 if(msg == '更新成功')
		            	 {	
		            		 news.content = content;
		            		 $("#note").text("保存成功");
		            		 $("#note").fadeOut(3000);
		            	 }
		             }
		        	
		        });
		    } 
			event.preventDefault();
	 } 
	 //取消编辑： 相当于删除本次新闻
	 var cancel = function(event){
		  // 删除本次新闻
		 var newContent = editor.txt.html();
		  console.log(newContent);
		  console.log(news.content);
		 if(newContent != news.content){
		 	var c = window.confirm("内容未保存，确定退出吗？");
		 	if(c == true){
	    		 //CloseWebPage();
	    		 window.history.back();
	    	}
		 }else{
			 window.history.back();
		 }
		event.preventDefault();
	 } 
	 // 发布新闻
	 function publish(){
		 if(news.nId != 0){
		        $.ajax({
		        	url:'/news/publish',
		        	type:'POST',
		        	contentType : 'application/json',  
		        	headers: {Authorization: 'Bearer ' + token },	
		        	data:JSON.stringify({
		        			nId:nId
		             }),
		             success:function(data){
		            	 result = JSON.parse(data);
		            	 state = result.state;
		            	 msg = result.msg;
		            	 $("#note").text(msg);
		             }
		        });
		    } 
		 event.preventDefault();
	 }
	 document.getElementById('cancel').addEventListener('click', cancel,false );
	 document.getElementById('save').addEventListener('click', save,false );
	</script>
</body>
</html>